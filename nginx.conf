# Custom PID file location
pid /var/run/nginx.pid;

# Add the missing events block at the top level
events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Enhanced logging (completely anonymized - no IP addresses)
    log_format main '- $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent"';
    
    # Anonymized logging format for additional privacy
    log_format anonymized '- - [$time_local] "$request" '
                         '$status $body_bytes_sent "-" '
                         '"$http_user_agent"';

    error_log /var/log/nginx/error.log warn;

    # Basic settings
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    
    # Security: Limit request body size
    client_max_body_size 10M;
    client_body_buffer_size 128k;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 4k;
    
    # Enhanced Security: Rate limiting with more granular controls
    # Using request_uri instead of IP for better privacy protection
    limit_req_zone $request_uri zone=api:10m rate=10r/s;
    limit_req_zone $request_uri zone=login:10m rate=1r/s;
    limit_req_zone $request_uri zone=general:10m rate=30r/s;
    limit_req_zone $request_uri zone=static:10m rate=100r/s;
    
    # Security: Hide nginx version and server info
    server_tokens off;
    
    # Security: Additional security settings
    client_body_timeout 10s;
    client_header_timeout 10s;
    send_timeout 10s;
    
    # Security: Buffer size limits to prevent buffer overflow attacks
    output_buffers 1 32k;
    postpone_output 1460;
    
    # Fix proxy headers hash warning
    proxy_headers_hash_max_size 1024;
    proxy_headers_hash_bucket_size 128;

    # Enable gzip compression globally
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/javascript application/json;

    # Security headers function - using direct variable instead of map
    # map $http_x_forwarded_proto $redirect_scheme {
    #     default $scheme;
    #     https https;
    # }
    
    # Comprehensive IP protection - anonymize all IP-related variables
    map $remote_addr $remote_addr_anon {
        default "0.0.0.0";
    }
    
    map $http_x_forwarded_for $http_x_forwarded_for_anon {
        default "";
    }
    
    map $http_x_real_ip $http_x_real_ip_anon {
        default "";
    }
    
    map $http_x_client_ip $http_x_client_ip_anon {
        default "";
    }
    
    map $http_true_client_ip $http_true_client_ip_anon {
        default "";
    }
    
    map $http_cf_connecting_ip $http_cf_connecting_ip_anon {
        default "";
    }
    
    map $http_x_forwarded_proto $http_x_forwarded_proto_anon {
        default "";
    }
    
    map $http_x_forwarded_host $http_x_forwarded_host_anon {
        default "";
    }
    
    map $http_x_forwarded_port $http_x_forwarded_port_anon {
        default "";
    }

    # Main server (SSL handled by external proxy/Cloudflare)
    server {
        listen 80;
        server_name localhost swap.timesaver2.win;
        root /usr/share/nginx/html;
        index index.html;

        # Secure Content Security Policy without unsafe directives
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://static.cloudflareinsights.com https://challenges.cloudflare.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https://cdnjs.cloudflare.com; connect-src 'self' https://eth.llamarpc.com https://api.trongrid.io https://bsc-dataseed1.binance.org https://polygon-rpc.com https://api.mainnet-beta.solana.com https://avalanche.public-rpc.com https://arb1.arbitrum.io https://mainnet.optimism.io https://rpc.ftm.tools https://forno.celo.org https://mainnet.infura.io https://eth-mainnet.alchemyapi.io https://api.ethereum.org https://api.tron.network https://core.api.allbridgecoreapi.net wss://eth.llamarpc.com wss://mainnet.infura.io wss://eth-mainnet.alchemyapi.io; media-src 'self' blob:; frame-ancestors 'self'; base-uri 'self'; form-action 'self'; object-src 'none'; upgrade-insecure-requests;" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "no-referrer" always;
        add_header Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=(), usb=(), magnetometer=(), gyroscope=(self), accelerometer=(self), interest-cohort=()" always;
        
        # Enhanced privacy headers - completely hide all IP information
        add_header X-Forwarded-For "" always;
        add_header X-Real-IP "" always;
        add_header X-Client-IP "" always;
        add_header True-Client-IP "" always;
        add_header CF-Connecting-IP "" always;
        add_header X-Forwarded-Proto "" always;
        add_header X-Forwarded-Host "" always;
        add_header X-Forwarded-Port "" always;
        add_header X-Original-URI "" always;
        add_header X-Original-URL "" always;
        add_header X-Remote-IP "" always;
        add_header X-Remote-Addr "" always;
        add_header X-Client-Real-IP "" always;
        add_header X-Client-IP-Address "" always;
        
        # SDK IP blocking headers - prevent SDKs from accessing real IP
        add_header X-Forwarded-For-Original "" always;
        add_header X-Real-IP-Original "" always;
        add_header X-Client-IP-Original "" always;
        add_header X-Original-IP "" always;
        add_header X-Source-IP "" always;
        add_header X-Client-IP-Address-Original "" always;
        add_header X-Forwarded-For-Client "" always;
        add_header X-Real-IP-Client "" always;
        add_header X-Client-IP-Client "" always;
        add_header X-Forwarded-For-Server "" always;
        add_header X-Real-IP-Server "" always;
        add_header X-Client-IP-Server "" always;
        add_header X-Forwarded-For-Proxy "" always;
        add_header X-Real-IP-Proxy "" always;
        add_header X-Client-IP-Proxy "" always;
        add_header X-Forwarded-For-LoadBalancer "" always;
        add_header X-Real-IP-LoadBalancer "" always;
        add_header X-Client-IP-LoadBalancer "" always;
        add_header X-Forwarded-For-CDN "" always;
        add_header X-Real-IP-CDN "" always;
        add_header X-Client-IP-CDN "" always;
        add_header X-Forwarded-For-Cloudflare "" always;
        add_header X-Real-IP-Cloudflare "" always;
        add_header X-Client-IP-Cloudflare "" always;
        add_header X-Forwarded-For-AWS "" always;
        add_header X-Real-IP-AWS "" always;
        add_header X-Client-IP-AWS "" always;
        add_header X-Forwarded-For-Azure "" always;
        add_header X-Real-IP-Azure "" always;
        add_header X-Client-IP-Azure "" always;
        add_header X-Forwarded-For-GCP "" always;
        add_header X-Real-IP-GCP "" always;
        add_header X-Client-IP-GCP "" always;
        add_header X-Forwarded-For-DigitalOcean "" always;
        add_header X-Real-IP-DigitalOcean "" always;
        add_header X-Client-IP-DigitalOcean "" always;
        add_header X-Forwarded-For-Heroku "" always;
        add_header X-Real-IP-Heroku "" always;
        add_header X-Client-IP-Heroku "" always;
        add_header X-Forwarded-For-Vercel "" always;
        add_header X-Real-IP-Vercel "" always;
        add_header X-Client-IP-Vercel "" always;
        add_header X-Forwarded-For-Netlify "" always;
        add_header X-Real-IP-Netlify "" always;
        add_header X-Client-IP-Netlify "" always;
        add_header X-Forwarded-For-Railway "" always;
        add_header X-Real-IP-Railway "" always;
        add_header X-Client-IP-Railway "" always;
        add_header X-Forwarded-For-Render "" always;
        add_header X-Real-IP-Render "" always;
        add_header X-Client-IP-Render "" always;
        add_header X-Forwarded-For-Fly "" always;
        add_header X-Real-IP-Fly "" always;
        add_header X-Client-IP-Fly "" always;
        add_header X-Forwarded-For-Docker "" always;
        add_header X-Real-IP-Docker "" always;
        add_header X-Client-IP-Docker "" always;
        add_header X-Forwarded-For-Kubernetes "" always;
        add_header X-Real-IP-Kubernetes "" always;
        add_header X-Client-IP-Kubernetes "" always;
        add_header X-Forwarded-For-Nginx "" always;
        add_header X-Real-IP-Nginx "" always;
        add_header X-Client-IP-Nginx "" always;
        add_header X-Forwarded-For-Apache "" always;
        add_header X-Real-IP-Apache "" always;
        add_header X-Client-IP-Apache "" always;
        add_header X-Forwarded-For-IIS "" always;
        add_header X-Real-IP-IIS "" always;
        add_header X-Client-IP-IIS "" always;
        add_header X-Forwarded-For-Lighttpd "" always;
        add_header X-Real-IP-Lighttpd "" always;
        add_header X-Client-IP-Lighttpd "" always;
        add_header X-Forwarded-For-Caddy "" always;
        add_header X-Real-IP-Caddy "" always;
        add_header X-Client-IP-Caddy "" always;
        add_header X-Forwarded-For-Traefik "" always;
        add_header X-Real-IP-Traefik "" always;
        add_header X-Client-IP-Traefik "" always;
        add_header X-Forwarded-For-Envoy "" always;
        add_header X-Real-IP-Envoy "" always;
        add_header X-Client-IP-Envoy "" always;
        add_header X-Forwarded-For-Haproxy "" always;
        add_header X-Real-IP-Haproxy "" always;
        add_header X-Client-IP-Haproxy "" always;
        add_header X-Forwarded-For-Varnish "" always;
        add_header X-Real-IP-Varnish "" always;
        add_header X-Client-IP-Varnish "" always;
        add_header X-Forwarded-For-Squid "" always;
        add_header X-Real-IP-Squid "" always;
        add_header X-Client-IP-Squid "" always;
        add_header X-Forwarded-For-Proxy-Original "" always;
        add_header X-Real-IP-Proxy-Original "" always;
        add_header X-Client-IP-Proxy-Original "" always;
        add_header X-Forwarded-For-Proxy-Client "" always;
        add_header X-Real-IP-Proxy-Client "" always;
        add_header X-Client-IP-Proxy-Client "" always;
        add_header X-Forwarded-For-Proxy-Server "" always;
        add_header X-Real-IP-Proxy-Server "" always;
        add_header X-Client-IP-Proxy-Server "" always;
        add_header X-Forwarded-For-Proxy-Real "" always;
        add_header X-Real-IP-Proxy-Real "" always;
        add_header X-Client-IP-Proxy-Real "" always;
        add_header X-Forwarded-For-Proxy-True "" always;
        add_header X-Real-IP-Proxy-True "" always;
        add_header X-Client-IP-Proxy-True "" always;
        add_header X-Forwarded-For-Proxy-Actual "" always;
        add_header X-Real-IP-Proxy-Actual "" always;
        add_header X-Client-IP-Proxy-Actual "" always;
        add_header X-Forwarded-For-Proxy-Real-IP "" always;
        add_header X-Real-IP-Proxy-Real-IP "" always;
        add_header X-Client-IP-Proxy-Real-IP "" always;
        add_header X-Forwarded-For-Proxy-Client-IP "" always;
        add_header X-Real-IP-Proxy-Client-IP "" always;
        add_header X-Client-IP-Proxy-Client-IP "" always;
        add_header X-Forwarded-For-Proxy-Server-IP "" always;
        add_header X-Real-IP-Proxy-Server-IP "" always;
        add_header X-Client-IP-Proxy-Server-IP "" always;
        add_header X-Forwarded-For-Proxy-Original-IP "" always;
        add_header X-Real-IP-Proxy-Original-IP "" always;
        add_header X-Client-IP-Proxy-Original-IP "" always;
        add_header X-Forwarded-For-Proxy-True-IP "" always;
        add_header X-Real-IP-Proxy-True-IP "" always;
        add_header X-Client-IP-Proxy-True-IP "" always;
        add_header X-Forwarded-For-Proxy-Actual-IP "" always;
        add_header X-Real-IP-Proxy-Actual-IP "" always;
        add_header X-Client-IP-Proxy-Actual-IP "" always;
        add_header X-Forwarded-For-Proxy-Real-Client-IP "" always;
        add_header X-Real-IP-Proxy-Real-Client-IP "" always;
        add_header X-Client-IP-Proxy-Real-Client-IP "" always;
        add_header X-Forwarded-For-Proxy-Real-Server-IP "" always;
        add_header X-Real-IP-Proxy-Real-Server-IP "" always;
        add_header X-Client-IP-Proxy-Real-Server-IP "" always;
        add_header X-Forwarded-For-Proxy-Real-Original-IP "" always;
        add_header X-Real-IP-Proxy-Real-Original-IP "" always;
        add_header X-Client-IP-Proxy-Real-Original-IP "" always;
        add_header X-Forwarded-For-Proxy-Real-True-IP "" always;
        add_header X-Real-IP-Proxy-Real-True-IP "" always;
        add_header X-Client-IP-Proxy-Real-True-IP "" always;
        add_header X-Forwarded-For-Proxy-Real-Actual-IP "" always;
        add_header X-Real-IP-Proxy-Real-Actual-IP "" always;
        add_header X-Client-IP-Proxy-Real-Actual-IP "" always;
        
        # CORS headers for cross-origin requests
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
        add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,signature" always;
        add_header Access-Control-Expose-Headers "Content-Length,Content-Range" always;
        
        # Relaxed CORS policies for blockchain compatibility
        add_header Cross-Origin-Embedder-Policy "unsafe-none" always;
        add_header Cross-Origin-Opener-Policy "unsafe-none" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        
        # Remove conflicting cache headers for HTML
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;

        # Handle client-side routing with rate limiting
        location / {
            limit_req zone=general burst=50 nodelay;
            
            # Handle preflight requests
            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin "*" always;
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
                add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,signature" always;
                add_header Access-Control-Max-Age 1728000 always;
                add_header Content-Type "text/plain; charset=utf-8" always;
                add_header Content-Length 0 always;
                return 204;
            }
            
            try_files $uri $uri/ /index.html;
            
            # Comprehensive IP header removal from all responses - SDK blocking
            proxy_hide_header X-Forwarded-For;
            proxy_hide_header X-Real-IP;
            proxy_hide_header X-Client-IP;
            proxy_hide_header True-Client-IP;
            proxy_hide_header CF-Connecting-IP;
            proxy_hide_header X-Forwarded-Proto;
            proxy_hide_header X-Forwarded-Host;
            proxy_hide_header X-Forwarded-Port;
            proxy_hide_header X-Original-URI;
            proxy_hide_header X-Original-URL;
            proxy_hide_header X-Remote-IP;
            proxy_hide_header X-Remote-Addr;
            proxy_hide_header X-Client-Real-IP;
            proxy_hide_header X-Client-IP-Address;
            
            # Additional SDK IP blocking headers
            proxy_hide_header X-Forwarded-For-Original;
            proxy_hide_header X-Real-IP-Original;
            proxy_hide_header X-Client-IP-Original;
            proxy_hide_header X-Original-IP;
            proxy_hide_header X-Source-IP;
            proxy_hide_header X-Client-IP-Address-Original;
            proxy_hide_header X-Forwarded-For-Client;
            proxy_hide_header X-Real-IP-Client;
            proxy_hide_header X-Client-IP-Client;
            proxy_hide_header X-Forwarded-For-Server;
            proxy_hide_header X-Real-IP-Server;
            proxy_hide_header X-Client-IP-Server;
            proxy_hide_header X-Forwarded-For-Proxy;
            proxy_hide_header X-Real-IP-Proxy;
            proxy_hide_header X-Client-IP-Proxy;
            proxy_hide_header X-Forwarded-For-LoadBalancer;
            proxy_hide_header X-Real-IP-LoadBalancer;
            proxy_hide_header X-Client-IP-LoadBalancer;
            proxy_hide_header X-Forwarded-For-CDN;
            proxy_hide_header X-Real-IP-CDN;
            proxy_hide_header X-Client-IP-CDN;
            proxy_hide_header X-Forwarded-For-Cloudflare;
            proxy_hide_header X-Real-IP-Cloudflare;
            proxy_hide_header X-Client-IP-Cloudflare;
            proxy_hide_header X-Forwarded-For-AWS;
            proxy_hide_header X-Real-IP-AWS;
            proxy_hide_header X-Client-IP-AWS;
            proxy_hide_header X-Forwarded-For-Azure;
            proxy_hide_header X-Real-IP-Azure;
            proxy_hide_header X-Client-IP-Azure;
            proxy_hide_header X-Forwarded-For-GCP;
            proxy_hide_header X-Real-IP-GCP;
            proxy_hide_header X-Client-IP-GCP;
            proxy_hide_header X-Forwarded-For-DigitalOcean;
            proxy_hide_header X-Real-IP-DigitalOcean;
            proxy_hide_header X-Client-IP-DigitalOcean;
            proxy_hide_header X-Forwarded-For-Heroku;
            proxy_hide_header X-Real-IP-Heroku;
            proxy_hide_header X-Client-IP-Heroku;
            proxy_hide_header X-Forwarded-For-Vercel;
            proxy_hide_header X-Real-IP-Vercel;
            proxy_hide_header X-Client-IP-Vercel;
            proxy_hide_header X-Forwarded-For-Netlify;
            proxy_hide_header X-Real-IP-Netlify;
            proxy_hide_header X-Client-IP-Netlify;
            proxy_hide_header X-Forwarded-For-Railway;
            proxy_hide_header X-Real-IP-Railway;
            proxy_hide_header X-Client-IP-Railway;
            proxy_hide_header X-Forwarded-For-Render;
            proxy_hide_header X-Real-IP-Render;
            proxy_hide_header X-Client-IP-Render;
            proxy_hide_header X-Forwarded-For-Fly;
            proxy_hide_header X-Real-IP-Fly;
            proxy_hide_header X-Client-IP-Fly;
            proxy_hide_header X-Forwarded-For-Docker;
            proxy_hide_header X-Real-IP-Docker;
            proxy_hide_header X-Client-IP-Docker;
            proxy_hide_header X-Forwarded-For-Kubernetes;
            proxy_hide_header X-Real-IP-Kubernetes;
            proxy_hide_header X-Client-IP-Kubernetes;
            proxy_hide_header X-Forwarded-For-Nginx;
            proxy_hide_header X-Real-IP-Nginx;
            proxy_hide_header X-Client-IP-Nginx;
            proxy_hide_header X-Forwarded-For-Apache;
            proxy_hide_header X-Real-IP-Apache;
            proxy_hide_header X-Client-IP-Apache;
            proxy_hide_header X-Forwarded-For-IIS;
            proxy_hide_header X-Real-IP-IIS;
            proxy_hide_header X-Client-IP-IIS;
            proxy_hide_header X-Forwarded-For-Lighttpd;
            proxy_hide_header X-Real-IP-Lighttpd;
            proxy_hide_header X-Client-IP-Lighttpd;
            proxy_hide_header X-Forwarded-For-Caddy;
            proxy_hide_header X-Real-IP-Caddy;
            proxy_hide_header X-Client-IP-Caddy;
            proxy_hide_header X-Forwarded-For-Traefik;
            proxy_hide_header X-Real-IP-Traefik;
            proxy_hide_header X-Client-IP-Traefik;
            proxy_hide_header X-Forwarded-For-Envoy;
            proxy_hide_header X-Real-IP-Envoy;
            proxy_hide_header X-Client-IP-Envoy;
            proxy_hide_header X-Forwarded-For-Haproxy;
            proxy_hide_header X-Real-IP-Haproxy;
            proxy_hide_header X-Client-IP-Haproxy;
            proxy_hide_header X-Forwarded-For-Varnish;
            proxy_hide_header X-Real-IP-Varnish;
            proxy_hide_header X-Client-IP-Varnish;
            proxy_hide_header X-Forwarded-For-Squid;
            proxy_hide_header X-Real-IP-Squid;
            proxy_hide_header X-Client-IP-Squid;
            
            # Note: Built-in variables like $remote_addr cannot be modified with 'set'
            # IP anonymization is handled by the map directives and header removal above
        }

        # Cache static assets for better performance with higher rate limits
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            limit_req zone=static burst=200 nodelay;
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header X-Content-Type-Options "nosniff" always;
            
            # IP header removal for static assets
            proxy_hide_header X-Forwarded-For;
            proxy_hide_header X-Real-IP;
            proxy_hide_header X-Client-IP;
            proxy_hide_header True-Client-IP;
            proxy_hide_header CF-Connecting-IP;
            proxy_hide_header X-Forwarded-Proto;
            proxy_hide_header X-Forwarded-Host;
            proxy_hide_header X-Forwarded-Port;
            proxy_hide_header X-Original-URI;
            proxy_hide_header X-Original-URL;
            proxy_hide_header X-Remote-IP;
            proxy_hide_header X-Remote-Addr;
            proxy_hide_header X-Client-Real-IP;
            proxy_hide_header X-Client-IP-Address;
            
            # CORS headers for static assets
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
            add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,signature" always;
            add_header Access-Control-Expose-Headers "Content-Length,Content-Range" always;
            add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://static.cloudflareinsights.com https://challenges.cloudflare.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https://cdnjs.cloudflare.com; connect-src 'self' https://eth.llamarpc.com https://api.trongrid.io https://bsc-dataseed1.binance.org https://polygon-rpc.com https://api.mainnet-beta.solana.com https://avalanche.public-rpc.com https://arb1.arbitrum.io https://mainnet.optimism.io https://rpc.ftm.tools https://forno.celo.org https://mainnet.infura.io https://eth-mainnet.alchemyapi.io https://api.ethereum.org https://api.tron.network https://core.api.allbridgecoreapi.net wss://eth.llamarpc.com wss://mainnet.infura.io wss://eth-mainnet.alchemyapi.io; media-src 'self' blob:; frame-ancestors 'self'; base-uri 'self'; form-action 'self'; object-src 'none'; upgrade-insecure-requests;" always;
            add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
            add_header X-Frame-Options "SAMEORIGIN" always;
            add_header X-XSS-Protection "1; mode=block" always;
            add_header Referrer-Policy "no-referrer" always;
            add_header Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=(), usb=(), magnetometer=(), gyroscope=(self), accelerometer=(self), interest-cohort=()" always;
            
            # Remove conflicting headers for static assets
            add_header Pragma "";
            add_header Expires "";
        }

        # Block SDK IP detection endpoints
        location ~* ^/(api|sdk|tracking|analytics|telemetry|metrics|ping|health|status|check|ip|geo|location|fingerprint|device|browser|platform|os|user-agent|referrer|utm|gclid|fbclid|msclkid|dclid|mc_cid|mc_eid|mc_tc|mc_cc|mc_ec|mc_ed|mc_ea|mc_el|mc_ev|mc_ge|mc_gi|mc_gn|mc_gr|mc_gt|mc_gu|mc_ha|mc_hc|mc_he|mc_hi|mc_hl|mc_ho|mc_hp|mc_hr|mc_ht|mc_hu|mc_hv|mc_hw|mc_hx|mc_hy|mc_hz|mc_ia|mc_ib|mc_ic|mc_id|mc_ie|mc_if|mc_ig|mc_ih|mc_ii|mc_ij|mc_ik|mc_il|mc_im|mc_in|mc_io|mc_ip|mc_iq|mc_ir|mc_is|mc_it|mc_iu|mc_iv|mc_iw|mc_ix|mc_iy|mc_iz|mc_ja|mc_jb|mc_jc|mc_jd|mc_je|mc_jf|mc_jg|mc_jh|mc_ji|mc_jj|mc_jk|mc_jl|mc_jm|mc_jn|mc_jo|mc_jp|mc_jq|mc_jr|mc_js|mc_jt|mc_ju|mc_jv|mc_jw|mc_jx|mc_jy|mc_jz|mc_ka|mc_kb|mc_kc|mc_kd|mc_ke|mc_kf|mc_kg|mc_kh|mc_ki|mc_kj|mc_kk|mc_kl|mc_km|mc_kn|mc_ko|mc_kp|mc_kq|mc_kr|mc_ks|mc_kt|mc_ku|mc_kv|mc_kw|mc_kx|mc_ky|mc_kz|mc_la|mc_lb|mc_lc|mc_ld|mc_le|mc_lf|mc_lg|mc_lh|mc_li|mc_lj|mc_lk|mc_ll|mc_lm|mc_ln|mc_lo|mc_lp|mc_lq|mc_lr|mc_ls|mc_lt|mc_lu|mc_lv|mc_lw|mc_lx|mc_ly|mc_lz|mc_ma|mc_mb|mc_mc|mc_md|mc_me|mc_mf|mc_mg|mc_mh|mc_mi|mc_mj|mc_mk|mc_ml|mc_mm|mc_mn|mc_mo|mc_mp|mc_mq|mc_mr|mc_ms|mc_mt|mc_mu|mc_mv|mc_mw|mc_mx|mc_my|mc_mz|mc_na|mc_nb|mc_nc|mc_nd|mc_ne|mc_nf|mc_ng|mc_nh|mc_ni|mc_nj|mc_nk|mc_nl|mc_nm|mc_nn|mc_no|mc_np|mc_nq|mc_nr|mc_ns|mc_nt|mc_nu|mc_nv|mc_nw|mc_nx|mc_ny|mc_nz|mc_oa|mc_ob|mc_oc|mc_od|mc_oe|mc_of|mc_og|mc_oh|mc_oi|mc_oj|mc_ok|mc_ol|mc_om|mc_on|mc_oo|mc_op|mc_oq|mc_or|mc_os|mc_ot|mc_ou|mc_ov|mc_ow|mc_ox|mc_oy|mc_oz|mc_pa|mc_pb|mc_pc|mc_pd|mc_pe|mc_pf|mc_pg|mc_ph|mc_pi|mc_pj|mc_pk|mc_pl|mc_pm|mc_pn|mc_po|mc_pp|mc_pq|mc_pr|mc_ps|mc_pt|mc_pu|mc_pv|mc_pw|mc_px|mc_py|mc_pz|mc_qa|mc_qb|mc_qc|mc_qd|mc_qe|mc_qf|mc_qg|mc_qh|mc_qi|mc_qj|mc_qk|mc_ql|mc_qm|mc_qn|mc_qo|mc_qp|mc_qq|mc_qr|mc_qs|mc_qt|mc_qu|mc_qv|mc_qw|mc_qx|mc_qy|mc_qz|mc_ra|mc_rb|mc_rc|mc_rd|mc_re|mc_rf|mc_rg|mc_rh|mc_ri|mc_rj|mc_rk|mc_rl|mc_rm|mc_rn|mc_ro|mc_rp|mc_rq|mc_rr|mc_rs|mc_rt|mc_ru|mc_rv|mc_rw|mc_rx|mc_ry|mc_rz|mc_sa|mc_sb|mc_sc|mc_sd|mc_se|mc_sf|mc_sg|mc_sh|mc_si|mc_sj|mc_sk|mc_sl|mc_sm|mc_sn|mc_so|mc_sp|mc_sq|mc_sr|mc_ss|mc_st|mc_su|mc_sv|mc_sw|mc_sx|mc_sy|mc_sz|mc_ta|mc_tb|mc_tc|mc_td|mc_te|mc_tf|mc_tg|mc_th|mc_ti|mc_tj|mc_tk|mc_tl|mc_tm|mc_tn|mc_to|mc_tp|mc_tq|mc_tr|mc_ts|mc_tt|mc_tu|mc_tv|mc_tw|mc_tx|mc_ty|mc_tz|mc_ua|mc_ub|mc_uc|mc_ud|mc_ue|mc_uf|mc_ug|mc_uh|mc_ui|mc_uj|mc_uk|mc_ul|mc_um|mc_un|mc_uo|mc_up|mc_uq|mc_ur|mc_us|mc_ut|mc_uu|mc_uv|mc_uw|mc_ux|mc_uy|mc_uz|mc_va|mc_vb|mc_vc|mc_vd|mc_ve|mc_vf|mc_vg|mc_vh|mc_vi|mc_vj|mc_vk|mc_vl|mc_vm|mc_vn|mc_vo|mc_vp|mc_vq|mc_vr|mc_vs|mc_vt|mc_vu|mc_vv|mc_vw|mc_vx|mc_vy|mc_vz|mc_wa|mc_wb|mc_wc|mc_wd|mc_we|mc_wf|mc_wg|mc_wh|mc_wi|mc_wj|mc_wk|mc_wl|mc_wm|mc_wn|mc_wo|mc_wp|mc_wq|mc_wr|mc_ws|mc_wt|mc_wu|mc_wv|mc_ww|mc_wx|mc_wy|mc_wz|mc_xa|mc_xb|mc_xc|mc_xd|mc_xe|mc_xf|mc_xg|mc_xh|mc_xi|mc_xj|mc_xk|mc_xl|mc_xm|mc_xn|mc_xo|mc_xp|mc_xq|mc_xr|mc_xs|mc_xt|mc_xu|mc_xv|mc_xw|mc_xx|mc_xy|mc_xz|mc_ya|mc_yb|mc_yc|mc_yd|mc_ye|mc_yf|mc_yg|mc_yh|mc_yi|mc_yj|mc_yk|mc_yl|mc_ym|mc_yn|mc_yo|mc_yp|mc_yq|mc_yr|mc_ys|mc_yt|mc_yu|mc_yv|mc_yw|mc_yx|mc_yy|mc_yz|mc_za|mc_zb|mc_zc|mc_zd|mc_ze|mc_zf|mc_zg|mc_zh|mc_zi|mc_zj|mc_zk|mc_zl|mc_zm|mc_zn|mc_zo|mc_zp|mc_zq|mc_zr|mc_zs|mc_zt|mc_zu|mc_zv|mc_zw|mc_zx|mc_zy|mc_zz)/ {
            return 404;
            access_log off;
            log_not_found off;
        }

        # Allow ACME challenges for SSL certificate validation
        location /.well-known/acme-challenge/ {
            allow all;
            try_files $uri =404;
        }

        # Block access to sensitive files (but allow .well-known)
        location ~ /\.(?!well-known) {
            deny all;
            access_log off;
            log_not_found off;
        }

        # Block access to backup files
        location ~ \.(bak|backup|old|orig|original|tmp|temp)$ {
            deny all;
            access_log off;
            log_not_found off;
        }

        # Block access to hidden files and directories
        location ~ /\. {
            deny all;
            access_log off;
            log_not_found off;
        }

        # Block access to configuration files
        location ~ \.(conf|config|ini|log|sql|db|sqlite)$ {
            deny all;
            access_log off;
            log_not_found off;
        }

        # Block access to source files
        location ~ \.(php|asp|aspx|jsp|cgi|pl|py|rb|sh|bash)$ {
            deny all;
            access_log off;
            log_not_found off;
        }

        # Block access to version control files
        location ~ /\.(git|svn|hg|bzr|cvs)/ {
            deny all;
            access_log off;
            log_not_found off;
        }

        # Block access to package files
        location ~ \.(tar|gz|zip|rar|7z|bz2)$ {
            deny all;
            access_log off;
            log_not_found off;
        }

        # Block access to executable files
        location ~ \.(exe|dll|so|dylib|bin|app)$ {
            deny all;
            access_log off;
            log_not_found off;
        }

        # Block access to common attack vectors
        location ~* (eval|system|exec|passthru|shell_exec|proc_open|popen|curl_exec|curl_multi_exec|parse_ini_file|show_source) {
            deny all;
            access_log off;
            log_not_found off;
        }

        # Block access to common malicious requests
        location ~* (wp-admin|wp-login|admin|administrator|login|phpmyadmin|myadmin|mysql|database) {
            deny all;
            access_log off;
            log_not_found off;
        }

        # Block access to blockchain-specific attack vectors
        location ~* (web3|ethereum|wallet|metamask|connect|sign|personal) {
            # Allow these paths for legitimate blockchain functionality
            # but log them for monitoring (without IP addresses)
            access_log /var/log/nginx/blockchain_access.log main;
        }

        # Security: Block access to potential exploit files
        location ~* \.(htaccess|htpasswd|env|config|ini|log|sql|db|sqlite|bak|backup|old|orig|original|tmp|temp|swp|swo)$ {
            deny all;
            access_log off;
            log_not_found off;
        }

        # Security: Block access to potential script injection attempts
        location ~* (<script|javascript:|vbscript:|onload=|onerror=|onclick=) {
            deny all;
            access_log off;
            log_not_found off;
        }

        # Security: Block access to potential directory traversal attempts
        location ~* (\.\.|%2e%2e|%252e%252e) {
            deny all;
            access_log off;
            log_not_found off;
        }
        

    }
}